// BACKEND: Prisma schema for Supabase PostgreSQL database
// This defines models for non-profit organization profiles with user authentication

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
}

// Reference table for user types
model UserType {
  id            Int       @id @default(autoincrement())
  userTypeTitle String    @unique
  description   String
  
  // One-to-many relationship with AppUser
  users         AppUser[]
  
  @@map("user_type")
}

model AppUser {
  id         String   @id @default(uuid())
  username   String   @unique
  email      String   @unique
  password   String   // Hashed with bcrypt
  name       String
  
  // Foreign key to UserType
  userTypeId Int?
  userType   UserType? @relation(fields: [userTypeId], references: [id])
  
  // One-to-one relationship with Profile
  profile    Profile?
  
  // One-to-one relationship with DonorProfile
  donorProfile DonorProfile?
  
  // One-to-many relationship with Likes
  likes      Like[]
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  @@map("app_users")
}

model Profile {
  id      String  @id @default(uuid())
  userId  String  @unique
  user    AppUser @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // File information (optional - for uploaded proposals)
  fileName  String?
  s3Key     String?
  s3Url     String?
  
  // Non-profit organization information
  organizationName      String?
  ein                   String?
  missionStatement      String?
  yearFounded           String?
  locationServed        String?
  biggestAccomplishment String?
  oneSentenceSummary    String?
  legalDesignation      String?
  primaryCauseAreas     String[] @default([])
  populations           String[] @default([])
  geographicalFocus     String?
  
  // One-to-many relationship with Likes
  likes     Like[]
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("profiles")
}

model Like {
  id        String   @id @default(uuid())
  userId    String   // User who performed the action
  user      AppUser  @relation(fields: [userId], references: [id], onDelete: Cascade)
  profileId String   // Profile that was liked/passed
  profile   Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  action    String   // "like" or "pass"
  createdAt DateTime @default(now())
  
  @@unique([userId, profileId]) // One action per user-profile pair
  @@map("likes")
}

// Reference table for primary cause areas
model PrimaryCauseArea {
  id              Int      @id @default(autoincrement())
  causeAreaTitle  String   @unique
  description     String
  
  // Many-to-many relationship with DonorProfile
  donorProfiles   DonorProfileCauseArea[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@map("primary_cause_areas")
}

// Reference table for populations
model Population {
  id              Int      @id @default(autoincrement())
  populationTitle String   @unique
  description     String
  
  // Many-to-many relationship with DonorProfile
  donorProfiles   DonorProfilePopulation[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@map("populations")
}

// Reference table for geographic focus
model GeographicFocus {
  id                Int      @id @default(autoincrement())
  geographicTitle   String   @unique
  description       String
  
  // Many-to-many relationship with DonorProfile
  donorProfiles     DonorProfileGeographicFocus[]
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@map("geographic_focus")
}

// Reference table for donation styles
model DonationStyle {
  id                  Int      @id @default(autoincrement())
  donationStyleTitle  String   @unique
  description         String
  
  // Many-to-many relationship with DonorProfile
  donorProfiles       DonorProfileDonationStyle[]
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  @@map("donation_style")
}

// Donor profile table
model DonorProfile {
  id                  String   @id @default(uuid())
  userId              String   @unique
  user                AppUser  @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Many-to-many relationships through junction tables
  causeAreas          DonorProfileCauseArea[]
  populations         DonorProfilePopulation[]
  geographicFocuses   DonorProfileGeographicFocus[]
  donationStyles      DonorProfileDonationStyle[]
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  @@map("donor_profile")
}

// Junction table for DonorProfile and PrimaryCauseArea (many-to-many)
model DonorProfileCauseArea {
  id              String           @id @default(uuid())
  donorProfileId  String
  donorProfile    DonorProfile     @relation(fields: [donorProfileId], references: [id], onDelete: Cascade)
  causeAreaId     Int
  causeArea       PrimaryCauseArea @relation(fields: [causeAreaId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime         @default(now())
  
  @@unique([donorProfileId, causeAreaId])
  @@map("donor_profile_cause_area")
}

// Junction table for DonorProfile and Population (many-to-many)
model DonorProfilePopulation {
  id              String       @id @default(uuid())
  donorProfileId  String
  donorProfile    DonorProfile @relation(fields: [donorProfileId], references: [id], onDelete: Cascade)
  populationId    Int
  population      Population   @relation(fields: [populationId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime     @default(now())
  
  @@unique([donorProfileId, populationId])
  @@map("donor_profile_population")
}

// Junction table for DonorProfile and GeographicFocus (many-to-many)
model DonorProfileGeographicFocus {
  id                String          @id @default(uuid())
  donorProfileId    String
  donorProfile      DonorProfile    @relation(fields: [donorProfileId], references: [id], onDelete: Cascade)
  geographicFocusId Int
  geographicFocus   GeographicFocus @relation(fields: [geographicFocusId], references: [id], onDelete: Cascade)
  
  createdAt         DateTime        @default(now())
  
  @@unique([donorProfileId, geographicFocusId])
  @@map("donor_profile_geographic_focus")
}

// Junction table for DonorProfile and DonationStyle (many-to-many)
model DonorProfileDonationStyle {
  id              String        @id @default(uuid())
  donorProfileId  String
  donorProfile    DonorProfile  @relation(fields: [donorProfileId], references: [id], onDelete: Cascade)
  donationStyleId Int
  donationStyle   DonationStyle @relation(fields: [donationStyleId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime      @default(now())
  
  @@unique([donorProfileId, donationStyleId])
  @@map("donor_profile_donation_style")
}
